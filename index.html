<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edytor Mermaid.js z Pan/Zoom</title>
    <!-- Import czcionki Inter dla ładniejszego wyglądu -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500&family=Fira+Code&display=swap" rel="stylesheet">
    
    <!-- 1. Załadowanie biblioteki Panzoom -->
    <script src="https://unpkg.com/panzoom@9.4.3/dist/panzoom.min.js"></script>

    <style>
        /* Podstawowy reset stylów */
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            overflow: hidden; /* Zapobiega przewijaniu całej strony */
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
        }

        /* Główny kontener aplikacji (Flexbox) */
        #app-container {
            display: flex;
            height: 100vh; /* 100% wysokości okna przeglądarki */
            width: 100%;
        }

        /* Panel edytora (lewa strona) */
        #editor-pane {
            width: 30%; /* Początkowa szerokość */
            min-width: 200px; /* Minimalna szerokość edytora */
            flex-shrink: 0; /* Zapobiega kurczeniu się panelu */
            padding: 1rem;
            box-sizing: border-box;
            background-color: #ffffff;
            display: flex;
            flex-direction: column;
        }

        /* Pasek do zmiany rozmiaru */
        #resizer {
            flex: 0 0 8px; /* Stała szerokość 8px */
            background-color: #e5e7eb;
            cursor: col-resize;
            border-left: 1px solid #d1d5db;
            border-right: 1px solid #d1d5db;
        }
        #resizer:hover {
            background-color: #d1d5db; /* Podświetlenie przy najechaniu */
        }
        
        /* Klasa dodawana do body podczas przeciągania */
        body.is-resizing, body.is-resizing * {
            cursor: col-resize !important;
            user-select: none; /* Zapobiega zaznaczaniu tekstu */
        }

        /* Panel podglądu (prawa strona) */
        #preview-pane {
            flex: 1; /* Zajmuje resztę dostępnego miejsca */
            min-width: 300px; /* Minimalna szerokość podglądu */
            padding: 1.5rem;
            box-sizing: border-box;
            background-color: #f9fafb;
            overflow: hidden; 
            display: flex;
            justify-content: center;
            align-items: flex-start;
            cursor: grab;
        }

        /* Pole tekstowe do wpisywania kodu Mermaid */
        #markdown-input {
            width: 100%;
            flex-grow: 1; 
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 0.75rem;
            font-family: 'Fira Code', monospace; 
            font-size: 14px;
            line-height: 1.6;
            resize: none; 
            box-sizing: border-box;
            background-color: #fafafa;
        }

        #markdown-input:focus {
            outline: 2px solid #3b82f6;
            border-color: transparent;
        }

        /* Kontener na wyrenderowany diagram */
        #mermaid-output {
            /* Rozmiar zostanie dopasowany przez SVG wewnątrz */
        }
        
        /* Stylizacja komunikatów o błędach */
        .error-message {
            font-family: 'Fira Code', monospace;
            color: #ef4444;
            background-color: #fee2e2;
            padding: 1rem;
            border-radius: 8px;
            white-space: pre-wrap; 
        }
    </style>
</head>
<body>

    <!-- Główna struktura aplikacji -->
    <div id="app-container">
        
        <!-- Lewy panel: Edytor -->
        <div id="editor-pane">
            <textarea id="markdown-input"></textarea>
        </div>
        
        <!-- Separator -->
        <div id="resizer"></div>

        <!-- Prawy panel: Podgląd -->
        <div id="preview-pane">
            <div id="mermaid-output" class="mermaid">
                <!-- Diagram zostanie wyrenderowany tutaj -->
            </div>
        </div>

    </div>

    <!-- Załadowanie biblioteki Mermaid.js z CDN -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>

    <script>
        // Domyślny tekst diagramu (POPRAWIONY - usunięto 'f' na końcu)
        const defaultMermaidCode = `flowchart LR
    A[Start] --> B(Proces 1)
    B --> C{Decyzja}
    C -->|Tak| D[Wynik A]
    C -->|Nie| E[Wynik B]
    D --> F[Koniec]
    E --> F[Koniec]`;

        // Inicjalizacja Mermaid.js
        mermaid.initialize({ 
            startOnLoad: false,
            theme: 'default' 
        });

        // Czekamy, aż cała strona (DOM) się załaduje
        document.addEventListener('DOMContentLoaded', () => {
            
            // Pobieramy elementy DOM
            const editor = document.getElementById('markdown-input');
            const preview = document.getElementById('preview-pane');
            const mermaidContainer = document.getElementById('mermaid-output');
            const editorPane = document.getElementById('editor-pane');
            const resizer = document.getElementById('resizer');
            
            // Klucz do localStorage
            const storageKey = 'mermaidEditorContent';
            
            // --- LOGIKA ZMIANY ROZMIARU PANELI ---
            let isResizing = false;

            resizer.addEventListener('mousedown', (e) => {
                isResizing = true;
                document.body.classList.add('is-resizing');
                document.addEventListener('mousemove', handleMouseMove);
                document.addEventListener('mouseup', handleMouseUp);
                e.preventDefault();
            });

            const handleMouseMove = (e) => {
                if (!isResizing) return;
                let newLeftWidth = e.clientX;
                const minEditorWidth = 200;
                const minPreviewWidth = 300;
                const totalWidth = document.body.clientWidth;
                const resizerWidth = resizer.offsetWidth;

                if (newLeftWidth < minEditorWidth) {
                    newLeftWidth = minEditorWidth;
                }
                if (totalWidth - newLeftWidth - resizerWidth < minPreviewWidth) {
                    newLeftWidth = totalWidth - minPreviewWidth - resizerWidth;
                }
                editorPane.style.width = `${newLeftWidth}px`;
            };

            const handleMouseUp = () => {
                isResizing = false;
                document.body.classList.remove('is-resizing');
                document.removeEventListener('mousemove', handleMouseMove);
                document.removeEventListener('mouseup', handleMouseUp);
            };

            // --- LOGIKA PAN & ZOOM ---
            
            // Zmienna przechowująca instancję panzoom
            let pzInstance = null;

            // Nasłuchiwanie na kółko myszy w panelu podglądu
            preview.addEventListener('wheel', (event) => {
                // Nie rób nic, jeśli panzoom nie jest aktywny (np. podczas błędu)
                if (!pzInstance) return; 

                event.preventDefault();

                const zoomSpeed = 0.05;
                const delta = event.deltaY > 0 ? -1 : 1; 
                const scaleMultiplier = Math.exp(delta * zoomSpeed);
                const currentScale = pzInstance.getTransform().scale;
                const newScale = currentScale * scaleMultiplier;
                
                // Oblicz pozycję myszy względem panelu podglądu
                const rect = preview.getBoundingClientRect();
                const clientX = event.clientX - rect.left;
                const clientY = event.clientY - rect.top;

                pzInstance.zoomAbs(clientX, clientY, newScale);
                
            }, { passive: false }); 

            // Zmiana kursora podczas przeciągania tła
            preview.addEventListener('mousedown', (e) => { 
                if (e.target === preview) { // Tylko jeśli kliknięto tło, nie diagram
                    preview.style.cursor = 'grabbing'; 
                }
            });
            preview.addEventListener('mouseup', () => { 
                preview.style.cursor = 'grab'; 
            });

            // --- LOGIKA RENDEROWANIA MERMAID ---
            const updatePreview = async () => {
                const code = editor.value;
                
                // Zapisz w localStorage przy każdej zmianie
                localStorage.setItem(storageKey, code);
                
                try {
                    const svgId = 'mermaid-svg-' + new Date().getTime();
                    const { svg } = await mermaid.render(svgId, code);

                    // 1. Zniszcz (dispose) starą instancję panzoom, jeśli istnieje
                    if (pzInstance) {
                        pzInstance.dispose(); // POPRAWKA: destroy -> dispose
                    }

                    // 2. Wstaw nowe SVG do kontenera
                    mermaidContainer.innerHTML = svg;

                    // 3. Stwórz NOWĄ instancję panzoom na kontenerze,
                    //    który TERAZ zawiera już SVG.
                    pzInstance = panzoom(mermaidContainer, {
                        minZoom: 0.2, 
                        maxZoom: 5,   
                        bounds: true, 
                        boundsPadding: 0.1
                    });

                } catch (error) {
                    console.error('Błąd renderowania Mermaid:', error);
                    
                    // Jeśli wystąpił błąd, również zniszcz (dispose) instancję panzoom
                    if (pzInstance) {
                        pzInstance.dispose(); // POPRAWKA: destroy -> dispose
                        pzInstance = null;
                    }
                    
                    mermaidContainer.innerHTML = `<pre class="error-message">Błąd składni diagramu:\n\n${error.message}</pre>`;
                }
            };

            // Inicjalizacja aplikacji
            const savedCode = localStorage.getItem(storageKey);
            if (savedCode) {
                editor.value = savedCode;
            } else {
                editor.value = defaultMermaidCode;
            }
            
            editor.addEventListener('input', updatePreview);
            updatePreview(); // Pierwsze renderowanie
        });
    </script>

</body>
</html>


